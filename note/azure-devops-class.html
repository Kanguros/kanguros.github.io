<!doctype html><html lang=en><meta charset=utf-8><meta content=IE=edge http-equiv=X-UA-Compatible><meta content=width=device-width,initial-scale=1 name=viewport><title>Kamil's Scratchpad - Azure Devops Class
</title><link href=https://kanguros.github.io/theme/css/bootstrap.min.css rel=stylesheet><link href=https://kanguros.github.io/theme/css/bootstrap-icons.css rel=stylesheet><link href=https://kanguros.github.io/theme/css/code_blocks/darkly.css rel=stylesheet><link href=https://kanguros.github.io/theme/css/clean-blog.css rel=stylesheet><meta content="Short wrapper for Azure Devops API. Based on azure-core." name=description><meta content=azure-devops name=tags><meta content=python name=tags><meta content=en property=og:locale><meta content="Kamil's Scratchpad" property=og:site_name><meta content=article property=og:type><meta content=https://kanguros.github.io/note/azure-devops-class.html property=og:url><meta content="Azure Devops Class" property=og:title><meta content="2023-09-01 00:00:00+02:00" property=article:published_time><meta content="Short wrapper for Azure Devops API. Based on azure-core." property=og:description><meta content=https://kanguros.github.io/theme/images/post-bg.jpg property=og:image><body class="article-azure-devops-class d-flex flex-column vh-100"><div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1"><nav class="navbar navbar-expand-lg container px-2"><a class=navbar-brand href=https://kanguros.github.io>kangúros</a><button aria-label="Toggle navigation" aria-controls=#navbarNav aria-expanded=false class=navbar-toggler data-bs-target=#navbarNav data-bs-toggle=collapse type=button><span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse justify-content-end" id=navbarNav><ul class="nav navbar-nav"><li class=nav-item><a class="btn btn-navigation mx-2 float-end" href=https://kanguros.github.io/articles.html>Articles</a><li class=nav-item><a class="btn btn-navigation mx-2 float-end" href=https://kanguros.github.io/notes.html>Notes</a><li class=nav-item><a class="btn btn-navigation mx-2 float-end" href=https://kanguros.github.io/about.html>About</a></ul></div></nav><hr></div><header class=intro-header><div class=container><div class=row><div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1"><div class=article-heading><a title="Azure Devops Class" href=/note/azure-devops-class.html rel=bookmark> <h1>Azure Devops Class</h1> </a><p class=meta-element><i class="bi bi-sticky"></i> Note <i class="bi bi-dot"></i> <i class="bi bi-calendar"></i> 2023-09-01 <i class="bi bi-dot"></i> <i class="bi bi-book"></i> 6 minutes<div class="tags meta-element"><a href=/tags/azure-devops rel=bookmark title=azure-devops> #azure-devops </a><a href=/tags/python rel=bookmark title=python> #python </a></div></div></div></div></div></header><div class=container><div class=row><div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1"><article><p>Here you will find a Python utility class, <code>AzureDevOps</code>, to streamline Azure DevOps interactions. The class makes it easy to fetch closed User Stories and manage active Pull Requests.<h2 id=features><a class=toclink href=#features>Features</a></h2><ul><li><p><strong>User Stories Retrieval:</strong> Fetch closed User Stories based on days, tags, and area path.</p><li><p><strong>Pull Requests Management:</strong> Retrieve active Pull Requests by repository prefix and authors.</p></ul><h2 id=usage><a class=toclink href=#usage>Usage</a></h2><ol><li><strong>User Stories:</strong></ol><p><code>python
   user_stories = azure_devops.get_closed_user_stories(days, tag, area_path)</code><ol><li><p><strong>Pull Requests:</strong></p> <ul><li>Active Pull Requests by Repository Prefix:</ul> <p><code>python
  active_pulls_by_repo = azure_devops.get_active_pull_requests_by_repo_prefix(prefix)</code></p> <ul><li>Active Pull Requests by Authors:</ul> <p><code>python
  active_pulls_by_authors = azure_devops.get_active_pull_requests_by_authors(authors)</code></p></ol><h2 id=getting-started><a class=toclink href=#getting-started>Getting Started</a></h2><ol><li>Install packages:</ol><p><code>bash
   pip install azure-devops azure-devops-work-item-tracking azure-devops-git</code><ol><li><p>Replace <code>"YOUR_ORGANIZATION_URL"</code> and <code>"YOUR_PERSONAL_ACCESS_TOKEN"</code>.</p><li><p>Customize example usage in the <code>if __name__ == "__main__":</code> block.</p><li><p>Run the script.</p></ol><h2 id=code><a class=toclink href=#code>Code</a></h2><div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
<span class=kn>from</span> <span class=nn>azure.core.credentials</span> <span class=kn>import</span> <span class=n>AzureDevOpsPATCredential</span>
<span class=kn>from</span> <span class=nn>azure.devops.connection</span> <span class=kn>import</span> <span class=n>Connection</span>
<span class=kn>from</span> <span class=nn>azure.devops.v6_0.work_item_tracking.models</span> <span class=kn>import</span> <span class=n>Wiql</span><span class=p>,</span> <span class=n>WorkItemExpand</span>
<span class=kn>from</span> <span class=nn>azure.devops.v6_0.git.models</span> <span class=kn>import</span> <span class=n>GitPullRequestSearchCriteria</span>
<span class=kn>import</span> <span class=nn>datetime</span>

<span class=n>AZURE_ORGANIZATION_URL</span> <span class=o>=</span> <span class=s2>"YOUR_ORGANIZATION_URL"</span>
<span class=n>AZURE_PERSONAL_ACCESS_TOKEN</span> <span class=o>=</span> <span class=s2>"YOUR_PERSONAL_ACCESS_TOKEN"</span>


<span class=k>class</span> <span class=nc>AzureDevOps</span><span class=p>:</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>connection</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_azure_devops_connection</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>wit_client</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>clients</span><span class=o>.</span><span class=n>get_work_item_tracking_client</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>git_client</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>clients</span><span class=o>.</span><span class=n>get_git_client</span><span class=p>()</span>

    <span class=k>def</span> <span class=nf>_create_azure_devops_connection</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-></span> <span class=n>Connection</span><span class=p>:</span>
<span class=w>        </span><span class=sd>"""Create an Azure DevOps connection instance.</span>

<span class=sd>        Returns:</span>
<span class=sd>            Connection: An instance of the Azure DevOps connection.</span>
<span class=sd>        """</span>
        <span class=n>credentials</span> <span class=o>=</span> <span class=n>AzureDevOpsPATCredential</span><span class=p>(</span><span class=n>AZURE_PERSONAL_ACCESS_TOKEN</span><span class=p>)</span>
        <span class=n>connection</span> <span class=o>=</span> <span class=n>Connection</span><span class=p>(</span><span class=n>base_url</span><span class=o>=</span><span class=n>AZURE_ORGANIZATION_URL</span><span class=p>,</span> <span class=n>creds</span><span class=o>=</span><span class=n>credentials</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>connection</span>

    <span class=k>def</span> <span class=nf>get_closed_user_stories</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>days</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>tag</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>area_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-></span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>"""Get closed User Stories filtered by days, tag, and area path.</span>

<span class=sd>        Args:</span>
<span class=sd>            days (int): Number of days to consider for closed User Stories.</span>
<span class=sd>            tag (str): Tag to filter User Stories.</span>
<span class=sd>            area_path (str): Area path to filter User Stories.</span>

<span class=sd>        Returns:</span>
<span class=sd>            list: List of closed User Stories matching the criteria. Each User Story is represented as a dictionary with detailed fields.</span>
<span class=sd>                Each dictionary includes the following keys:</span>
<span class=sd>                - 'id' (int): Work item ID.</span>
<span class=sd>                - 'fields' (dict): Dictionary containing various fields of the User Story.</span>
<span class=sd>                    The 'fields' dictionary includes keys like:</span>
<span class=sd>                    - 'System.Title': Title of the User Story.</span>
<span class=sd>                    - 'System.AreaPath': Area path of the User Story.</span>
<span class=sd>                    - 'System.State': State of the User Story.</span>
<span class=sd>                    - 'System.Tags': Tags associated with the User Story.</span>
<span class=sd>                    - 'System.ChangedDate': Date when the User Story was last changed.</span>
<span class=sd>                    - ... and more fields based on Azure DevOps schema.</span>
<span class=sd>        """</span>
        <span class=n>wiql_query</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>"SELECT * FROM workitems WHERE [System.Tags] CONTAINS '</span><span class=si>{</span><span class=n>tag</span><span class=si>}</span><span class=s2>' AND [System.State] = 'Closed' AND [System.ChangedDate] >= @today - </span><span class=si>{</span><span class=n>days</span><span class=si>}</span><span class=s2> AND [System.AreaPath] = '</span><span class=si>{</span><span class=n>area_path</span><span class=si>}</span><span class=s2>'"</span>
        <span class=n>wiql</span> <span class=o>=</span> <span class=n>Wiql</span><span class=p>(</span><span class=n>query</span><span class=o>=</span><span class=n>wiql_query</span><span class=p>)</span>
        <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>wit_client</span><span class=o>.</span><span class=n>query_by_wiql</span><span class=p>(</span><span class=n>wiql</span><span class=p>,</span> <span class=n>organization</span><span class=o>=</span><span class=n>AZURE_ORGANIZATION_URL</span><span class=p>)</span>

        <span class=n>work_item_ids</span> <span class=o>=</span> <span class=p>[</span><span class=n>work_item</span><span class=o>.</span><span class=n>id</span> <span class=k>for</span> <span class=n>work_item</span> <span class=ow>in</span> <span class=n>results</span><span class=o>.</span><span class=n>work_items</span><span class=p>]</span>

        <span class=n>expand_options</span> <span class=o>=</span> <span class=n>WorkItemExpand</span><span class=o>.</span><span class=n>All</span>
        <span class=n>user_stories</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>wit_client</span><span class=o>.</span><span class=n>get_work_items</span><span class=p>(</span><span class=n>ids</span><span class=o>=</span><span class=n>work_item_ids</span><span class=p>,</span> <span class=n>expand</span><span class=o>=</span><span class=n>expand_options</span><span class=p>)</span>

        <span class=k>return</span> <span class=p>[</span><span class=n>us</span><span class=o>.</span><span class=n>as_dict</span><span class=p>()</span> <span class=k>for</span> <span class=n>us</span> <span class=ow>in</span> <span class=n>user_stories</span><span class=p>]</span>

    <span class=k>def</span> <span class=nf>get_git_repositories</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-></span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>"""Get a list of Git repositories.</span>

<span class=sd>        Returns:</span>
<span class=sd>            list: List of Git repositories. Each repository is represented as a dictionary with information including 'id', 'name', and 'url'.</span>
<span class=sd>        """</span>
        <span class=n>repositories</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>git_client</span><span class=o>.</span><span class=n>get_repositories</span><span class=p>(</span><span class=n>organization</span><span class=o>=</span><span class=n>AZURE_ORGANIZATION_URL</span><span class=p>)</span>
        <span class=k>return</span> <span class=p>[</span><span class=n>repo</span><span class=o>.</span><span class=n>as_dict</span><span class=p>()</span> <span class=k>for</span> <span class=n>repo</span> <span class=ow>in</span> <span class=n>repositories</span><span class=p>]</span>

    <span class=k>def</span> <span class=nf>get_active_pull_requests_by_repo_prefix</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prefix</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-></span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>"""Get active Pull Requests from Repositories with a given prefix.</span>

<span class=sd>        Args:</span>
<span class=sd>            prefix (str): Prefix of the repository name.</span>

<span class=sd>        Returns:</span>
<span class=sd>            list: List of active Pull Requests matching the criteria. Each Pull Request is represented as a dictionary with detailed fields.</span>
<span class=sd>                Each dictionary includes the following keys:</span>
<span class=sd>                - 'pullRequestId' (int): Pull Request ID.</span>
<span class=sd>                - 'title' (str): Title of the Pull Request.</span>
<span class=sd>                - 'repository' (dict): Dictionary containing repository information, including 'name' and 'url'.</span>
<span class=sd>                - ... and more fields based on Azure DevOps schema.</span>
<span class=sd>        """</span>
        <span class=n>repositories</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_git_repositories</span><span class=p>()</span>

        <span class=n>active_pull_requests</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>repo</span> <span class=ow>in</span> <span class=n>repositories</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>repo</span><span class=p>[</span><span class=s1>'name'</span><span class=p>]</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>prefix</span><span class=p>):</span>
                <span class=n>prs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>git_client</span><span class=o>.</span><span class=n>get_pull_requests</span><span class=p>(</span><span class=n>repository_id</span><span class=o>=</span><span class=n>repo</span><span class=p>[</span><span class=s1>'id'</span><span class=p>],</span>
                                                        <span class=n>search_criteria</span><span class=o>=</span><span class=n>GitPullRequestSearchCriteria</span><span class=p>(</span><span class=n>status</span><span class=o>=</span><span class=s2>"active"</span><span class=p>))</span>
                <span class=n>active_pull_requests</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>prs</span><span class=p>)</span>

        <span class=k>return</span> <span class=p>[</span><span class=n>pr</span><span class=o>.</span><span class=n>as_dict</span><span class=p>()</span> <span class=k>for</span> <span class=n>pr</span> <span class=ow>in</span> <span class=n>active_pull_requests</span><span class=p>]</span>

    <span class=k>def</span> <span class=nf>get_active_pull_requests_by_authors</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>persons</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>])</span> <span class=o>-></span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>"""Get active Pull Requests from Repositories created by specific persons.</span>

<span class=sd>        Args:</span>
<span class=sd>            persons (list): List of persons' names who created the Pull Requests.</span>

<span class=sd>        Returns:</span>
<span class=sd>            list: List of active Pull Requests matching the criteria. Each Pull Request is represented as a dictionary with detailed fields.</span>
<span class=sd>                Each dictionary includes the following keys:</span>
<span class=sd>                - 'pullRequestId' (int): Pull Request ID.</span>
<span class=sd>                - 'title' (str): Title of the Pull Request.</span>
<span class=sd>                - 'createdBy' (dict): Dictionary containing information about the person who created the Pull Request.</span>
<span class=sd>                - 'repository' (dict): Dictionary containing repository information, including 'name' and 'url'.</span>
<span class=sd>                - ... and more fields based on Azure DevOps schema.</span>
<span class=sd>        """</span>
        <span class=n>active_pull_requests</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>person</span> <span class=ow>in</span> <span class=n>persons</span><span class=p>:</span>
            <span class=n>prs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>git_client</span><span class=o>.</span><span class=n>get_pull_requests</span><span class=p>(</span><span class=n>creator_id</span><span class=o>=</span><span class=n>person</span><span class=p>,</span>
                                                    <span class=n>search_criteria</span><span class=o>=</span><span class=n>GitPullRequestSearchCriteria</span><span class=p>(</span><span class=n>status</span><span class=o>=</span><span class=s2>"active"</span><span class=p>))</span>
            <span class=n>active_pull_requests</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>prs</span><span class=p>)</span>

        <span class=k>return</span> <span class=p>[</span><span class=n>pr</span><span class=o>.</span><span class=n>as_dict</span><span class=p>()</span> <span class=k>for</span> <span class=n>pr</span> <span class=ow>in</span> <span class=n>active_pull_requests</span><span class=p>]</span>


<span class=c1># Usage example</span>
<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>"__main__"</span><span class=p>:</span>
    <span class=n>azure_devops</span> <span class=o>=</span> <span class=n>AzureDevOps</span><span class=p>()</span>

    <span class=c1># Example usage of User Stories function</span>
    <span class=n>days</span> <span class=o>=</span> <span class=mi>7</span>
    <span class=n>tag</span> <span class=o>=</span> <span class=s2>"YOUR_TAG"</span>
    <span class=n>area_path</span> <span class=o>=</span> <span class=s2>"YOUR_AREA_PATH"</span>
    <span class=n>user_stories</span> <span class=o>=</span> <span class=n>azure_devops</span><span class=o>.</span><span class=n>get_closed_user_stories</span><span class=p>(</span><span class=n>days</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>area_path</span><span class=p>)</span>

    <span class=c1># Example usage of Pull Requests functions</span>
    <span class=n>prefix</span> <span class=o>=</span> <span class=s2>"repo_prefix"</span>
    <span class=n>active_pulls_by_repo</span> <span class=o>=</span> <span class=n>azure_devops</span><span class=o>.</span><span class=n>get_active_pull_requests_by_repo_prefix</span><span class=p>(</span><span class=n>prefix</span><span class=p>)</span>

    <span class=n>authors</span> <span class=o>=</span> <span class=p>[</span><span class=s2>"person1"</span><span class=p>,</span> <span class=s2>"person2"</span><span class=p>]</span>
    <span class=n>active_pulls_by_authors</span> <span class=o>=</span> <span class=n>azure_devops</span><span class=o>.</span><span class=n>get_active_pull_requests_by_authors</span><span class=p>(</span><span class=n>authors</span><span class=p>)</span>
</code></pre></div></article><div class=related-posts><hr class=section-line><h1 class=subheading>Related posts</h1><ul><li><a href=https://kanguros.github.io/note/requests-using-pytest.html> Requests using pytest </a> <div class="d-flex justify-content-start meta-elements"><i class="bi bi-calendar"></i> 2023-09-01 <i class="bi bi-dot"></i><i class="bi bi-book"></i> 6 minutes</div><li><a href=https://kanguros.github.io/note/pacli-wrapper.html> <span class=caps>PACLI</span> Wrapper </a> <div class="d-flex justify-content-start meta-elements"><i class="bi bi-calendar"></i> 2023-09-01 <i class="bi bi-dot"></i><i class="bi bi-book"></i> 6 minutes</div></ul></div></div></div></div><footer class=footer><div class=row><div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1"><hr><p class="footer-links my-3"><a class=px-2 href=https://kanguros.github.io/articles.html> Articles </a> <a class=px-2 href=https://kanguros.github.io/notes.html> Notes </a> <a class=px-2 href=https://kanguros.github.io/about.html> About </a> <a class=px-2 href=https://kanguros.github.io/tags/index.html> Tags </a> <a class=px-2 href=https://kanguros.github.io/archive.html> Archive </a><hr class=little><p class=copyright>© Blog made by <a href=https://kanguros.github.io/about.html>Kamil Urbanek</a>, powered by <a href=http://getpelican.com>Pelican</a>, on modified <a href=https://github.com/BlackrockDigital/startbootstrap-clean-blog>Clean Blog</a> theme.</div></div></footer><script src=https://kanguros.github.io/theme/js/jquery.min.js></script><script src=https://kanguros.github.io/theme/js/bootstrap.min.js></script><script src=https://kanguros.github.io/theme/js/clean-blog.js></script>